<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salary History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: #f4f6f8;
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
    }
    .loader-wrapper {
  display: none;
  text-align: center;
  padding: 30px 0;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e0e0e0;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-wrapper p {
  margin-top: 10px;
  font-size: 14px;
  color: #555;
}

    .card {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    h2 {
      margin-bottom: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #f1f3f6;
      font-weight: 700;
    }

    tr:hover {
      background: #f9f9f9;
    }

    .back-btn {
      margin-bottom: 15px;
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
    .filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 15px;
}

.filters select,
.filters input {
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 13px;
}

.reset-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.reset-btn:hover {
  background: #b02a37;
}
.total-box {
  margin-top: 15px;
  padding: 12px;
  background: #f1f8ff;
  border: 1px solid #007bff;
  border-radius: 10px;
  font-weight: 700;
  font-size: 16px;
  text-align: right;
  color: #007bff;
}
.table-wrap {
  overflow-x: auto;
}
.filter-item {
  display: flex;
  flex-direction: column;
}

.filter-item label {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}
.reset-btn {
  height: 42px;
  align-self: flex-end;
}
.filters {
  position: sticky;
  top: 0;
  background: #f4f6f8;
  z-index: 10;
}

@media (max-width: 600px) {
  .filters {
    flex-direction: column;
  }

  .filters select,
  .filters input,
  .reset-btn {
    width: 100%;
  }

  .total-box {
    text-align: center;
  }
}

  </style>
</head>

<body>
<div class="filters">

  <div class="filter-item">
    <label>Driver</label>
    <select id="driverFilter">
      <option value="">All Drivers</option>
    </select>
  </div>

  <div class="filter-item">
    <label>Payment Date</label>
    <input type="date" id="dateFilter">
  </div>

  <div class="filter-item">
    <label>Payment Month</label>
    <input type="month" id="monthFilter">
  </div>

  <button class="reset-btn" onclick="resetFilters()">Reset</button>

</div>
<div class="card">
    <div id="loader" class="loader-wrapper">
      <div class="spinner"></div>
      <p>Loading data...</p>
    </div>
  <button class="back-btn" onclick="location.href='driver-cost.html'">â¬… Back</button>

  <h2>ðŸ“œ Driver Salary History</h2>

<div class="table-wrap">
  <table id="historyTable">
    <thead>
      <tr>
        <th>Driver</th>
        <th>Amount</th>
        <th>Payment Date</th>
        <th>Trips</th>
        <th>Route</th>
        <th>Journey Date</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="total-box" id="totalSalary">
  Total Salary: â‚¹0
</div>
</div>
<script>
if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "login.html";
}
</script>
  <script>
    function showLoader() {
  document.getElementById("loader").style.display = "block";
}

function hideLoader() {
  document.getElementById("loader").style.display = "none";
}
  </script>
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwOT_jTPjNPoyPdatEuTzLgtsavZ3HNITJG-yvFR_fnTmDGB-hx2qlN_aMPgqKFVMiH/exec";
let salaryData = [];

/* FORMAT HELPERS */
function formatDate(v) {
  if (!v) return "";
  return new Date(v).toLocaleDateString("en-IN");
}

function formatTime(v) {
  if (!v) return "";
  return new Date(v).toLocaleTimeString("en-IN", {
    hour: "2-digit",
    minute: "2-digit"
  });
}

showLoader();

fetch(WEB_APP_URL + "?action=salaryHistory")
  .then(res => res.json())
  .then(data => {
    renderTable(data);
  })
  .catch(() => {
    alert("Failed to load data");
  })
  .finally(() => {
    hideLoader();
  });

function populateDriverFilter(data) {
  const driverSelect = document.getElementById("driverFilter");
  const drivers = [...new Set(data.map(d => d["Driver Name"]))];

  drivers.forEach(driver => {
    const opt = document.createElement("option");
    opt.value = driver;
    opt.textContent = driver;
    driverSelect.appendChild(opt);
  });
}

/* FILTER HANDLER */
document.querySelectorAll("#driverFilter, #dateFilter, #monthFilter")
  .forEach(el => el.addEventListener("change", applyFilters));

function applyFilters() {
  const driver = document.getElementById("driverFilter").value;
  const selectedDate = document.getElementById("dateFilter").value;
  const selectedMonth = document.getElementById("monthFilter").value;

  let filtered = salaryData.filter(row => {

    if (driver && row["Driver Name"] !== driver) {
      return false;
    }

    if (selectedDate) {
      const paymentDate = getLocalDateString(row["Payment Date"]);
      if (paymentDate !== selectedDate) {
        return false;
      }
    }

    if (selectedMonth) {
      const paymentMonth = getLocalDateString(row["Payment Date"]).slice(0, 7);
      if (paymentMonth !== selectedMonth) {
        return false;
      }
    }

    return true; 
  });

  renderTable(filtered);
}

function resetFilters() {
  document.getElementById("driverFilter").value = "";
  document.getElementById("dateFilter").value = "";
  document.getElementById("monthFilter").value = "";
  renderTable(salaryData);
}
function getLocalDateString(value) {
  if (!value) return "";
  const d = new Date(value);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`; // YYYY-MM-DD
}

function renderTable(data) {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">No records found</td></tr>`;
    updateTotal([]);
    return;
  }

  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row["Driver Name"]}</td>
      <td>â‚¹${row["Salary Amount"]}</td>
      <td>${formatDate(row["Payment Date"])}</td>
      <td>${row["No of Trips"]}</td>
      <td>${row["Trip Route"]}</td>
      <td>${formatDate(row["Journey Date"])}</td>
      <td>${formatTime(row["Payment Time"])}</td>
    `;
    tbody.appendChild(tr);
  });

  updateTotal(data);
}
function updateTotal(data) {
  const total = data.reduce((sum, row) => {
    return sum + Number(row["Salary Amount"] || 0);
  }, 0);

  document.getElementById("totalSalary").innerText =
    "Total Salary: â‚¹" + total.toLocaleString("en-IN");
}
</script>


</body>
</html>
